<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /var/www/html/public
    
    # Enable rewrite engine
    RewriteEngine On
    
    # Enhanced security headers for live testing
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https:;"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # PHP configuration (using mod_php in container)
    <FilesMatch \.php$>
        SetHandler application/x-httpd-php
    </FilesMatch>
    
    # PHP error handling for live testing
    php_flag display_errors off
    php_flag log_errors on
    php_value error_log /var/log/samfedbiz/php_errors.log
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
    php_value memory_limit 256M
    
    # Directory permissions with enhanced routing
    <Directory /var/www/html/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Enhanced routing for samfedbiz platform
        RewriteEngine On
        
        # Program routes: /programs/{code}
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^programs/([^/]+)/?$ programs/index.php?code=$1 [QSA,L]
        
        # Holder/Prime routes: /programs/{code}/holders/{id}
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^programs/([^/]+)/(holders|primes)/(\d+)/?$ programs/holder.php?code=$1&id=$3 [QSA,L]
        
        # Capability sheet routes
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^programs/oasis\+/capability-sheet/?$ programs/oasis+/capability-sheet.php [QSA,L]
        
        # Ordering guide routes
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^programs/sewp/ordering-guide/?$ programs/sewp/ordering-guide.php [QSA,L]
        
        # API routes (keep direct access)
        RewriteCond %{REQUEST_URI} ^/api/
        RewriteRule ^(.*)$ - [L]
        
        # Default fallback for other clean URLs
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php [QSA,L]
    </Directory>
    
    # Deny access to sensitive directories and files
    <DirectoryMatch "/(src|database|cron|scripts|docker|storage|reports)">
        Require all denied
    </DirectoryMatch>
    
    # Protect configuration and sensitive files
    <FilesMatch "\.(env|log|ini|conf|sql)$">
        Require all denied
    </FilesMatch>
    
    # Protect specific files
    <Files "composer.json">
        Require all denied
    </Files>
    
    <Files "composer.lock">
        Require all denied
    </Files>
    
    # Static file caching
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2)$">
        ExpiresActive On
        ExpiresDefault "access plus 30 days"
        Header set Cache-Control "public, immutable"
    </LocationMatch>
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/samfedbiz_error.log
    CustomLog ${APACHE_LOG_DIR}/samfedbiz_access.log combined
</VirtualHost>